<div class="billing">
  <div class="header">
    <h1>Billing & Invoicing</h1>
    <button class="btn btn-primary" (click)="toggleForm()">
      {{ showForm ? 'Cancel' : 'Create Invoice' }}
    </button>
  </div>

  <!-- Success/Error Messages -->
  <div *ngIf="successMessage" class="alert alert-success">
    {{ successMessage }}
  </div>
  <div *ngIf="errorMessage" class="alert alert-error">
    {{ errorMessage }}
  </div>

  <!-- Invoice Form -->
  <div *ngIf="showForm" class="invoice-form-container">
    <h2>Create New Invoice</h2>
    <form [formGroup]="invoiceForm" (ngSubmit)="onSubmit()">
      <div class="form-group">
        <label for="appointmentId">Appointment *</label>
        <select 
          id="appointmentId" 
          formControlName="appointmentId"
          (change)="onAppointmentSelect()"
          [class.error]="invoiceForm.get('appointmentId')?.invalid && invoiceForm.get('appointmentId')?.touched"
        >
          <option value="">Select an appointment</option>
          <option *ngFor="let appointment of completedAppointments" [value]="appointment.id">
            {{ appointment.appointmentDate | date:'MM/dd/yyyy' }} - 
            {{ appointment.appointmentTime }}
          </option>
        </select>
        <span class="error-message" *ngIf="invoiceForm.get('appointmentId')?.invalid && invoiceForm.get('appointmentId')?.touched">
          Appointment is required
        </span>
      </div>

      <div *ngIf="selectedAppointment" class="appointment-info">
        <h3>Appointment Details</h3>
        <p><strong>Date:</strong> {{ selectedAppointment.appointmentDate | date:'MM/dd/yyyy' }}</p>
        <p><strong>Time:</strong> {{ selectedAppointment.appointmentTime }}</p>
        <p><strong>Duration:</strong> {{ selectedAppointment.durationMinutes }} minutes</p>
      </div>

      <div class="invoice-items">
        <div class="items-header">
          <h3>Services/Items</h3>
          <button type="button" class="btn btn-secondary" (click)="addItem()">
            Add Item
          </button>
        </div>

        <div *ngIf="items.length === 0" class="no-items">
          No items added. Click "Add Item" to add services.
        </div>

        <div *ngFor="let item of items.controls; let i = index" class="item-row" [formGroup]="$any(item)">
          <div class="item-fields">
            <div class="form-group">
              <label>Service *</label>
              <select formControlName="serviceId">
                <option value="">Select service</option>
                <option *ngFor="let service of services" [value]="service.id">
                  {{ service.name }} - ${{ service.price }}
                </option>
              </select>
            </div>

            <div class="form-group">
              <label>Quantity *</label>
              <input type="number" formControlName="quantity" min="1" />
            </div>

            <div class="form-group">
              <label>Unit Price *</label>
              <input type="number" formControlName="unitPrice" min="0" step="0.01" />
            </div>

            <div class="form-group">
              <label>Discount (%)</label>
              <input type="number" formControlName="discount" min="0" max="100" />
            </div>

            <div class="item-total">
              <label>Total</label>
              <span class="total-amount">${{ getItemTotal(i) | number:'1.2-2' }}</span>
            </div>

            <button type="button" class="btn btn-danger btn-sm" (click)="removeItem(i)">
              Remove
            </button>
          </div>
        </div>
      </div>

      <div class="invoice-summary">
        <div class="summary-row">
          <span>Total Amount:</span>
          <span class="total">${{ getInvoiceTotal() | number:'1.2-2' }}</span>
        </div>
      </div>

      <div class="form-group">
        <label for="notes">Notes</label>
        <textarea id="notes" formControlName="notes" rows="3"></textarea>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn btn-primary" [disabled]="isLoading || items.length === 0">
          {{ isLoading ? 'Creating...' : 'Create Invoice' }}
        </button>
        <button type="button" class="btn btn-secondary" (click)="toggleForm()">
          Cancel
        </button>
      </div>
    </form>
  </div>

  <!-- Invoices List -->
  <div class="invoices-list">
    <h2>Invoices</h2>
    <div *ngIf="isLoading" class="loading">Loading invoices...</div>
    
    <div *ngIf="!isLoading && invoices.length === 0" class="no-data">
      No invoices found. Create a new invoice to get started.
    </div>

    <table *ngIf="!isLoading && invoices.length > 0">
      <thead>
        <tr>
          <th>Invoice #</th>
          <th>Date</th>
          <th>Amount</th>
          <th>Tax</th>
          <th>Total</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let invoice of invoices">
          <td>{{ invoice.invoiceNumber }}</td>
          <td>{{ invoice.invoiceDate | date:'MM/dd/yyyy' }}</td>
          <td>${{ invoice.subtotal | number:'1.2-2' }}</td>
          <td>${{ invoice.taxAmount | number:'1.2-2' }}</td>
          <td>${{ invoice.totalAmount | number:'1.2-2' }}</td>
          <td>
            <span [ngClass]="getStatusClass(invoice.status)">
              {{ invoice.status }}
            </span>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
